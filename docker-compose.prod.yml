# Docker Compose for WhisprMessaging Production Environment
version: '3.8'

services:
  # WhisprMessaging Service
  messaging-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    environment:
      # Database (use external managed database in production)
      DATABASE_URL: ${DATABASE_URL}

      # Redis (use external managed Redis in production)
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DATABASE: ${REDIS_DATABASE:-0}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Phoenix
      PHX_HOST: 0.0.0.0
      PHX_PORT: 4000
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}

      # gRPC
      GRPC_PORT: 50052

      # Environment
      MIX_ENV: prod

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # External services
      SCHEDULING_SERVICE_GRPC_URL: ${SCHEDULING_SERVICE_GRPC_URL}

      # Security
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      JWT_SECRET: ${JWT_SECRET}

      # Observability
      TELEMETRY_ENABLED: ${TELEMETRY_ENABLED:-true}
      METRICS_PORT: ${METRICS_PORT:-9090}
      JAEGER_ENDPOINT: ${JAEGER_ENDPOINT}

      # Deployment
      RELEASE_NAME: ${RELEASE_NAME:-whispr-messaging}
      RELEASE_VERSION: ${RELEASE_VERSION:-latest}
      NODE_NAME: ${NODE_NAME:-messaging@${HOSTNAME}}
      ERLANG_COOKIE: ${ERLANG_COOKIE}

      # Rate limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-1000}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}

      # File storage
      FILE_STORAGE_BACKEND: ${FILE_STORAGE_BACKEND:-s3}
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${S3_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

      # CDN
      CDN_URL: ${CDN_URL}

      # Monitoring
      HEALTH_CHECK_PATH: ${HEALTH_CHECK_PATH:-/health}
      METRICS_PATH: ${METRICS_PATH:-/metrics}
    ports:
      - "${HTTP_PORT:-4000}:4000"
      - "${GRPC_PORT:-50052}:50052"
      - "${METRICS_PORT:-9090}:9090"
    volumes:
      - app_data:/app/data
      - app_logs:/app/logs
    deploy:
      replicas: ${REPLICAS:-2}
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: '${CPU_LIMIT:-1.0}'
          memory: ${MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${CPU_RESERVATION:-0.5}'
          memory: ${MEMORY_RESERVATION:-512M}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - whispr_network
      - traefik_network
    labels:
      # Traefik labels for reverse proxy
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_network"

      # HTTP router
      - "traefik.http.routers.messaging-http.rule=Host(`messaging.${DOMAIN:-whispr.local}`)"
      - "traefik.http.routers.messaging-http.entrypoints=web"
      - "traefik.http.routers.messaging-http.middlewares=redirect-to-https"

      # HTTPS router
      - "traefik.http.routers.messaging-https.rule=Host(`messaging.${DOMAIN:-whispr.local}`)"
      - "traefik.http.routers.messaging-https.entrypoints=websecure"
      - "traefik.http.routers.messaging-https.tls=true"
      - "traefik.http.routers.messaging-https.tls.certresolver=le"

      # Service
      - "traefik.http.services.messaging.loadbalancer.server.port=4000"

      # Middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

      # gRPC router
      - "traefik.tcp.routers.messaging-grpc.rule=HostSNI(`grpc-messaging.${DOMAIN:-whispr.local}`)"
      - "traefik.tcp.routers.messaging-grpc.entrypoints=grpc"
      - "traefik.tcp.routers.messaging-grpc.tls=true"
      - "traefik.tcp.routers.messaging-grpc.tls.certresolver=le"
      - "traefik.tcp.services.messaging-grpc.loadbalancer.server.port=50052"

  # Log aggregation
  fluentd:
    image: fluent/fluentd:edge-debian
    environment:
      FLUENTD_CONF: fluent.conf
    volumes:
      - ./logging/fluent.conf:/fluentd/etc/fluent.conf:ro
      - app_logs:/fluentd/log
    networks:
      - whispr_network

  # Backup service (for database backups)
  backup:
    image: alpine:latest
    environment:
      DATABASE_URL: ${DATABASE_URL}
      BACKUP_S3_BUCKET: ${BACKUP_S3_BUCKET}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./scripts/backup.sh:/backup.sh:ro
    command: >
      sh -c "
        apk add --no-cache postgresql-client aws-cli &&
        chmod +x /backup.sh &&
        crond -f
      "
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - whispr_network

volumes:
  app_data:
    driver: local
  app_logs:
    driver: local

networks:
  whispr_network:
    driver: overlay
    attachable: true
  traefik_network:
    external: true

configs:
  prometheus_config:
    external: true
  grafana_config:
    external: true

secrets:
  database_password:
    external: true
  redis_password:
    external: true
  encryption_key:
    external: true
  jwt_secret:
    external: true